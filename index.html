<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Backyard Putting Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Backyard Putting">
  <meta name="theme-color" content="#013220">

  <!-- Icons / manifest (optional but nice) -->
  <link rel="apple-touch-icon" href="apple-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="manifest" href="manifest.json">

  <!-- Chart.js for analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase compat (Spark-friendly and GH Pages‚Äìsafe) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      font-size: 16px;
    }
    body {
      margin: 0;
      background: #f5f5f7;
    }
    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      background: #fff;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    header {
      padding: 10px 16px 6px 16px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    #appLogo {
      width: 130px;
      display: block;
      margin: 0 auto 6px auto;
      border-radius: 50%;
    }
    header .subtitle {
      font-size: 0.8rem;
      color: #666;
      margin-top: 2px;
    }
    main {
      padding: 14px;
      flex: 1;
      position: relative;
    }
    footer {
      padding: 8px;
      text-align: center;
      font-size: 0.75rem;
      color: #888;
      border-top: 1px solid #eee;
    }

    .hidden { display: none; }

    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      font-size: 1rem;
      font-weight: 500;
      margin: 6px 0;
      background: #007aff;
      color: #fff;
    }
    .btn-secondary {
      background: #e5e5ea;
      color: #111;
    }
    .btn-small {
      display: inline-block;
      width: auto;
      padding: 8px 12px;
      font-size: 0.85rem;
      border-radius: 8px;
      border: none;
      margin: 4px 4px 0 0;
      background: #e5e5ea;
      color: #111;
    }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 8px;
    }
    ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    li {
      padding: 6px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      margin-bottom: 8px;
    }

    .pill {
      display: inline-block;
      padding: 3px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #f2f2f7;
      margin-left: 6px;
    }

    .player-row {
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      background: #f8f8fa;
    }

    .score-buttons button {
      margin: 5px;
      padding: 16px 20px;
      font-size: 1.2rem;
      border-radius: 12px;
      border: none;
      background: #e5e5ea;
    }
    .score-buttons button.selected {
      background: #34c759;
      color: #fff;
      transform: scale(1.15);
    }

    #roundHoleLabel {
      font-weight: 700;
      color: #007aff;
      font-size: 1.2rem;
      text-shadow: 0 0 6px rgba(0,122,255,0.2);
      margin-bottom: 4px;
    }

    .hole-label {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .banner {
      background: #f2f2f7;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 0.85rem;
      margin-bottom: 10px;
    }

    .fade-in {
      animation: fade 0.25s ease-out;
    }
    @keyframes fade {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .history-card {
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }
    .history-card strong {
      font-size: 0.85rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    th, td {
      padding: 4px;
      text-align: right;
    }
    th:first-child, td:first-child {
      text-align: left;
    }
    tr:nth-child(even) {
      background: #fafafa;
    }

    /* Scorecard (landscape) styles */
    #screen-scorecard table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }
    #screen-scorecard th,
    #screen-scorecard td {
      border: 1px solid #ddd;
      padding: 3px;
      text-align: center;
      white-space: nowrap;
    }
    #screen-scorecard th:first-child,
    #screen-scorecard td:first-child {
      text-align: left;
      position: sticky;
      left: 0;
      background: #fff;
    }

    .scorecell {
      cursor: pointer;
    }
    .scorecell.ace {
      background: #ffe58a;
      font-weight: 700;
    }
    .scorecell.birdie {
      background: #d4f8d4;
    }
    .scorecell.bogey {
      background: #ffd6d6;
    }

    /* Summary watermark */
    #summaryStamp {
      width: 200px;
      opacity: 0.1;
      position: fixed;
      top: 180px;
      left: 50%;
      transform: translateX(-50%);
      z-index: -1;
      pointer-events: none;
    }
    #summaryContent {
      margin-top: 40px;
      position: relative;
      z-index: 1;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <img id="appLogo" src="my-golf.jpg" alt="Backyard Putting Tracker Logo">
    <div class="subtitle">Barred Owl ¬∑ Great Horned Owl</div>
  </header>

  <main>
    <!-- HOME -->
    <section id="screen-home">
      <div class="section-title">Home</div>
      <button class="btn" id="btnHomeStart">Start Round</button>
      <button class="btn btn-secondary" id="btnHomePlayers">Players</button>
      <button class="btn btn-secondary" id="btnHomeHistory">History</button>
      <button class="btn btn-secondary" id="btnHomeAnalytics">Player Analytics</button>
      <button class="btn btn-secondary" id="btnHomeLeaderboard">Leaderboards</button>
      <button class="btn btn-secondary" id="btnHomeCourseAnalytics">Course Analytics</button>
      <button class="btn btn-secondary" id="btnHomeExport">Export Scores (CSV)</button>
      <button class="btn btn-secondary" id="btnExportJSON">Export Backup (JSON)</button>
      <button class="btn btn-secondary" id="btnImportBackup">Import Backup</button>
      <input id="backupFileInput" type="file" accept=".json" style="display:none;">
    </section>

    <!-- PLAYERS -->
    <section id="screen-players" class="hidden">
      <div class="section-title">Players</div>
      <input id="playerNameInput" type="text" placeholder="Add player (Luke, Mike, Gina...)">
      <button class="btn" id="btnAddPlayer">Add Player</button>
      <ul id="playersList"></ul>
      <button class="btn-small btn-secondary" id="btnBackFromPlayers">&lt; Home</button>
    </section>

    <!-- SELECT PLAYERS -->
    <section id="screen-select-players" class="hidden">
      <div class="section-title">Select Players</div>
      <ul id="playerSelectList"></ul>
      <button class="btn" id="btnStartRoundFromSelection">Begin Round</button>
      <button class="btn-small btn-secondary" id="btnBackFromSelect">&lt; Home</button>
    </section>

    <!-- ROUND (portrait scoring) -->
    <section id="screen-round" class="hidden">
      <div id="roundHoleLabel"></div>
      <div class="hole-label" id="holeTitle"></div>
      <div class="banner" id="roundScoreBanner"></div>
      <div id="scoreButtonsContainer"></div>

      <div style="margin-top:10px;">
        <button class="btn-small btn-secondary" id="btnPrevHole">&lt; Prev</button>
        <button class="btn-small btn-secondary" id="btnNextHole">Next &gt;</button>
      </div>

      <button class="btn" id="btnFinishRoundBottom" disabled style="margin-top:20px;opacity:0.4;">
        Save Round
      </button>
      <button class="btn-small btn-secondary" id="btnBackFromRound">&lt; Cancel Round</button>
    </section>

    <!-- SCORECARD (landscape view) -->
    <section id="screen-scorecard" class="hidden">
      <div class="section-title">Scorecard</div>
      <div id="scorecardTableContainer"></div>
      <p style="font-size:0.8rem;color:#666;margin-top:6px;">
        Rotate back to portrait to return to hole-by-hole view.
      </p>
    </section>

    <!-- SUMMARY -->
    <section id="screen-summary" class="hidden">
      <div class="section-title">Round Summary</div>
      <img id="summaryStamp" src="my-golf.jpg" alt="Course Logo">
      <div id="summaryContent"></div>
      <button class="btn" id="btnSummaryDone">Back to Home</button>
    </section>

    <!-- HISTORY -->
    <section id="screen-history" class="hidden">
      <div class="section-title">Recent Rounds</div>
      <div id="historyContent"></div>
      <button class="btn-small btn-secondary" id="btnBackFromHistory">&lt; Home</button>
    </section>

    <!-- PLAYER ANALYTICS -->
    <section id="screen-analytics" class="hidden">
      <div class="section-title">Player Analytics</div>
      <ul id="analyticsPlayerList"></ul>
      <div id="analyticsResults" style="margin-top:10px;"></div>
      <canvas id="handicapChart" width="400" height="220" style="margin-top:20px;"></canvas>
      <button class="btn-small btn-secondary" id="btnBackFromAnalytics">&lt; Home</button>
    </section>

    <!-- LEADERBOARDS -->
    <section id="screen-leaderboards" class="hidden">
      <div class="section-title">All-Time Leaderboards</div>
      <div id="leaderboardOverall" style="margin-top:10px;"></div>
      <div id="leaderboardBarred" style="margin-top:18px;"></div>
      <div id="leaderboardHorned" style="margin-top:18px;"></div>
      <button class="btn-small btn-secondary" id="btnBackFromLeaderboards">&lt; Home</button>
    </section>

    <!-- COURSE ANALYTICS -->
    <section id="screen-course-analytics" class="hidden">
      <div class="section-title">Course Analytics</div>
      <div id="courseAnalyticsContainer"></div>
      <canvas id="courseAnalyticsChart" height="260" style="margin-top:15px;"></canvas>
      <button class="btn-small btn-secondary" id="btnBackFromCourseAnalytics">&lt; Home</button>
    </section>
  </main>

  <footer>
    Backyard Putting Tracker ‚Ä¢ Family Putting History
  </footer>
</div>

<script>
/* =========================
   CORE CONSTANTS & HELPERS
   ========================= */
const PAR = 2;
const HOLES = 20;
const COURSE_PAR = PAR * HOLES;
const STORAGE_KEY = "backyard-putting_v1";

const HOLE_NAMES = [
  "First Flight", "Arrow Line", "Hunter‚Äôs Hook", "Rising Edge", "Gravity Glide",
  "Climbing Turn", "The Drop Point", "Gauntlet Ridge", "Perch Line", "Switchback",
  "Moon Curve", "The Ascent", "Silent Path", "Hollow Ridge", "The Horseshoe",
  "Reverse Shoe", "Second Ridge", "True North", "Slope Run", "Home Roost"
];

function fmtDiff(n) {
  const num = Number(n);
  if (Number.isNaN(num)) return "-";
  if (num > 0) return `+${num.toFixed ? num.toFixed(1) : num}`;
  if (num === 0) return "E";
  return `${num.toFixed ? num.toFixed(1) : num}`;
}

/* =========================
   GLOBAL STATE
   ========================= */
let appData = { players: [], rounds: [] };
let currentRound = null;
let editModeRoundId = null;

let handicapChartInstance = null;
let courseAnalyticsChart = null;

/* Firebase globals (compat) */
let db = null;

/* =========================
   LOCAL STORAGE
   ========================= */
function loadLocal() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (raw) {
    try {
      appData = JSON.parse(raw);
    } catch (e) {
      console.error("Error parsing local storage:", e);
    }
  }
  if (!appData.players) appData.players = [];
  if (!appData.rounds) appData.rounds = [];
}

function saveLocal() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
}

/* =========================
   FIREBASE (COMPAT) SETUP
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyCX9C7uy5JNklprp3tZeKV3tPGr410ix28",
  authDomain: "rio-links.firebaseapp.com",
  projectId: "rio-links",
  storageBucket: "rio-links.firebasestorage.app",
  messagingSenderId: "260295353704",
  appId: "1:260295353704:web:8700c3a72ccf786d1762dd",
  measurementId: "G-6MVV3ZFT3T"
};

function initFirebase() {
  try {
    if (!firebase.apps || !firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    db = firebase.firestore();
    loadFromFirebase();
  } catch (e) {
    console.warn("Firebase init failed; app will run local-only:", e);
  }
}

function getFamilyDocRef() {
  if (!db) return null;
  return db.collection("backyardPutting").doc("family-1");
}

async function loadFromFirebase() {
  try {
    const ref = getFamilyDocRef();
    if (!ref) return;
    const snap = await ref.get();
    if (snap.exists) {
      const data = snap.data();
      if (data.players && data.rounds) {
        appData = data;
        saveLocal();
        renderPlayers();
      }
    } else {
      await ref.set(appData);
    }
  } catch (e) {
    console.warn("Firebase load error:", e);
  }
}

async function saveToFirebase() {
  try {
    const ref = getFamilyDocRef();
    if (!ref) return;

    const incompleteExists = appData.rounds.some(r =>
      Object.values(r.scores || {}).some(arr => arr.includes(null))
    );
    if (incompleteExists) {
      console.warn("Skipped Firebase sync: incomplete round present.");
      return;
    }
    await ref.set(appData);
  } catch (e) {
    console.warn("Firebase save error:", e);
  }
}

/* =========================
   UTILS
   ========================= */
function showScreen(id) {
  document.querySelectorAll("main section").forEach(s => s.classList.add("hidden"));
  const el = document.getElementById(id);
  if (el) el.classList.remove("hidden");
}

function getPlayer(id) {
  return appData.players.find(p => p.id === id);
}

function getPlayerRounds(id) {
  return appData.rounds
    .filter(r => r.scores && r.scores[id])
    .sort((a,b) => new Date(a.date) - new Date(b.date));
}

function computeHandicap(id) {
  const rounds = getPlayerRounds(id).slice(-10);
  if (!rounds.length) return 0;
  const diffs = rounds.map(r => {
    const total = r.scores[id].reduce((a,b)=>a+b,0);
    return total - COURSE_PAR;
  });
  const avg = diffs.reduce((a,b)=>a+b,0) / diffs.length;
  return Number(avg.toFixed(1));
}

function getHandicapTimeline(id) {
  const rounds = getPlayerRounds(id);
  const timeline = [];
  for (let i = 0; i < rounds.length; i++) {
    const slice = rounds.slice(Math.max(0, i-9), i+1);
    const diffs = slice.map(r => {
      const total = r.scores[id].reduce((a,b)=>a+b,0);
      return total - COURSE_PAR;
    });
    const avg = diffs.reduce((a,b)=>a+b,0) / diffs.length;
    const handicap = Number(avg.toFixed(1));
    timeline.push({ date: new Date(rounds[i].date), handicap });
  }
  return timeline;
}

/* =========================
   PLAYERS
   ========================= */
function renderPlayers() {
  const ul = document.getElementById("playersList");
  if (!appData.players.length) {
    ul.innerHTML = "<li>No players yet.</li>";
    return;
  }
  ul.innerHTML = appData.players.map(p => {
    const hc = computeHandicap(p.id);
    const hcText = hc > 0 ? `+${hc.toFixed(1)}` : hc.toFixed(1);
    return `<li>${p.name}<span class="pill">hcp ${hcText}</span></li>`;
  }).join("");
}

function renderPlayerSelection() {
  const ul = document.getElementById("playerSelectList");
  if (!appData.players.length) {
    ul.innerHTML = "<li>No players yet.</li>";
    return;
  }
  ul.innerHTML = appData.players.map(p => `
    <li>
      <label style="display:flex;justify-content:space-between;align-items:center;">
        <span>${p.name}</span>
        <input type="checkbox" value="${p.id}">
      </label>
    </li>
  `).join("");
}

/* =========================
   SAVE BUTTON STATE
   ========================= */
function updateSaveButtonState() {
  const btn = document.getElementById("btnFinishRoundBottom");
  if (!currentRound) {
    btn.disabled = true;
    btn.style.opacity = "0.4";
    return;
  }
  const allFilled = currentRound.playerIds.every(pid =>
    currentRound.scores[pid].every(s => s !== null)
  );
  btn.disabled = !allFilled;
  btn.style.opacity = allFilled ? "1" : "0.4";
}

/* =========================
   ROUND RENDERING
   ========================= */
function renderRound() {
  if (!currentRound) return;
  const h = currentRound.currentHole;
  const hIndex = h - 1;

  const roundHoleLabel = document.getElementById("roundHoleLabel");
  const holeTitle = document.getElementById("holeTitle");
  const banner = document.getElementById("roundScoreBanner");
  const container = document.getElementById("scoreButtonsContainer");

  roundHoleLabel.textContent = `Hole ${h}/${HOLES}`;
  const courseName = h <= 10 ? "Barred Owl" : "Great Horned Owl";
  holeTitle.textContent = `${courseName} ¬∑ ${HOLE_NAMES[h-1]} (Par ${PAR})`;

  let bannerHtml = "";
  currentRound.playerIds.forEach(pid => {
    const scores = currentRound.scores[pid];
    const played = scores.filter(v => v !== null);
    const total = played.reduce((a,b)=>a+b,0);
    const diff = played.length ? total - played.length * PAR : 0;
    bannerHtml += `<div>${getPlayer(pid).name}: ${total || 0} (${fmtDiff(diff)})</div>`;
  });
  banner.innerHTML = bannerHtml || "No scores yet.";

  container.innerHTML = "";
  currentRound.playerIds.forEach(pid => {
    const row = document.createElement("div");
    row.className = "player-row";
    const label = document.createElement("div");
    label.textContent = getPlayer(pid).name;
    row.appendChild(label);

    const btnRow = document.createElement("div");
    btnRow.className = "score-buttons";

    [1,2,3,4,5].forEach(num => {
      const btn = document.createElement("button");
      btn.textContent = num;
      if (currentRound.scores[pid][hIndex] === num) btn.classList.add("selected");

      btn.onclick = () => {
        currentRound.scores[pid][hIndex] = num;
        renderRound();
        updateSaveButtonState();
        renderScorecard();

        const allPlayersScored = currentRound.playerIds.every(pid2 =>
          currentRound.scores[pid2][hIndex] !== null
        );
        if (allPlayersScored && currentRound.currentHole < HOLES) {
          setTimeout(() => {
            currentRound.currentHole++;
            renderRound();
            updateSaveButtonState();
            renderScorecard();
          }, 300);
        }
      };

      btnRow.appendChild(btn);
    });

    row.appendChild(btnRow);
    container.appendChild(row);
  });

  container.classList.add("fade-in");
  setTimeout(() => container.classList.remove("fade-in"), 250);

  updateSaveButtonState();
}

/* =========================
   SCORECARD (LANDSCAPE)
   ========================= */
function renderScorecard() {
  if (!currentRound) return;
  const container = document.getElementById("scorecardTableContainer");
  if (!container) return;
  container.innerHTML = "";

  const table = document.createElement("table");
  let headerHtml = "<tr><th>Player</th>";
  for (let i = 1; i <= HOLES; i++) headerHtml += `<th>${i}</th>`;
  headerHtml += "<th>Total</th><th>¬±</th></tr>";
  table.innerHTML = headerHtml;

  currentRound.playerIds.forEach(pid => {
    const player = getPlayer(pid);
    const scores = currentRound.scores[pid];
    let rowHtml = `<tr><td>${player ? player.name : "Player"}</td>`;

    scores.forEach((s, idx) => {
      let cls = "scorecell";
      if (s === 1) cls += " ace";
      else if (s === 2) cls += " birdie";
      else if (s !== null && s > PAR) cls += " bogey";

      rowHtml += `<td class="${cls}" data-player="${pid}" data-hole="${idx}">${s ?? "-"}</td>`;
    });

    const playedScores = scores.filter(v => v !== null);
    const playedCount = playedScores.length;
    let displayTotal = "-";
    let displayDiff = "-";
    if (playedCount > 0) {
      const partialTotal = playedScores.reduce((a,b)=>a+b,0);
      const expectedPar = playedCount * PAR;
      const partialDiff = partialTotal - expectedPar;
      displayTotal = partialTotal;
      displayDiff = fmtDiff(partialDiff);
    }
    rowHtml += `<td>${displayTotal}</td><td>${displayDiff}</td></tr>`;
    table.innerHTML += rowHtml;
  });

  container.appendChild(table);
}

/* Orientation: portrait = round, landscape = scorecard */
function handleOrientation() {
  if (!currentRound) return;
  const isLandscape = window.innerWidth > window.innerHeight;
  const visibleSection = document.querySelector("main section:not(.hidden)");
  const currentId = visibleSection ? visibleSection.id : null;

  if (isLandscape) {
    if (currentId === "screen-round" || currentId === "screen-scorecard") {
      renderScorecard();
      showScreen("screen-scorecard");
    }
  } else {
    if (currentId === "screen-scorecard") {
      showScreen("screen-round");
    }
  }
}

/* =========================
   FINALIZE ROUND
   ========================= */
async function finalizeRound() {
  if (!currentRound) return;
  const allFilled = currentRound.playerIds.every(pid =>
    currentRound.scores[pid].every(s => s !== null)
  );
  if (!allFilled) {
    alert("Please enter a score for every hole for every player.");
    return;
  }

  if (editModeRoundId) {
    const idx = appData.rounds.findIndex(r => r.id === editModeRoundId);
    if (idx >= 0) appData.rounds[idx] = currentRound;
  } else {
    appData.rounds.push(currentRound);
  }

  saveLocal();
  await saveToFirebase();

  renderSummary(currentRound);
  currentRound = null;
  editModeRoundId = null;
  showScreen("screen-summary");
}

/* =========================
   SUMMARY
   ========================= */
function renderSummary(round) {
  const div = document.getElementById("summaryContent");
  const date = new Date(round.date).toLocaleString();
  let html = `<div><strong>${date}</strong></div>`;

  let bestDiff = null;
  let winners = [];

  round.playerIds.forEach(pid => {
    const scores = round.scores[pid];
    const total = scores.reduce((a,b)=>a+b,0);
    const diff = total - COURSE_PAR;

    if (bestDiff === null || diff < bestDiff) {
      bestDiff = diff;
      winners = [getPlayer(pid).name];
    } else if (diff === bestDiff) {
      winners.push(getPlayer(pid).name);
    }

    const front = scores.slice(0,10).reduce((a,b)=>a+b,0);
    const back  = scores.slice(10).reduce((a,b)=>a+b,0);

    html += `
      <div style="margin-top:6px;">
        <strong>${getPlayer(pid).name}</strong>: ${total} (${fmtDiff(diff)})<br>
        Front (Barred Owl): ${front} ¬∑ Back (Great Horned): ${back}
      </div>
    `;
  });

  html += `<div style="margin-top:10px;">üèÜ Winner: ${winners.join(", ")}</div>`;
  div.innerHTML = html;
}

/* =========================
   HISTORY
   ========================= */
function renderHistory() {
  const div = document.getElementById("historyContent");
  if (!appData.rounds.length) {
    div.innerHTML = "<p>No rounds yet.</p>";
    return;
  }
  div.innerHTML = appData.rounds.slice().reverse().map(r => {
    const date = new Date(r.date).toLocaleString();
    let playersHtml = "";
    Object.keys(r.scores).forEach(pid => {
      const scores = r.scores[pid];
      const total = scores.reduce((a,b)=>a+b,0);
      const diff = total - COURSE_PAR;
      playersHtml += `${getPlayer(pid)?.name ?? "Player"}: ${total} (${fmtDiff(diff)})<br>`;
    });
    return `
      <div class="history-card">
        <strong>${date}</strong><br>
        ${playersHtml}
        <button class="btn-small" onclick="editRound('${r.id}')">Edit</button>
        <button class="btn-small btn-secondary" onclick="deleteRound('${r.id}')">Delete</button>
      </div>
    `;
  }).join("");
}

window.deleteRound = async function(id) {
  if (!confirm("Delete round?")) return;
  appData.rounds = appData.rounds.filter(r => r.id !== id);
  saveLocal();
  await saveToFirebase();
  renderHistory();
};

window.editRound = function(id) {
  const r = appData.rounds.find(x => x.id === id);
  if (!r) return;
  editModeRoundId = id;
  currentRound = JSON.parse(JSON.stringify(r));
  renderRound();
  handleOrientation();
  showScreen("screen-round");
};

/* =========================
   PLAYER ANALYTICS
   ========================= */
function computeAnalytics(pid) {
  const rounds = getPlayerRounds(pid);
  if (!rounds.length) return null;
  const totals = rounds.map(r => r.scores[pid].reduce((a,b)=>a+b,0));
  const avg = totals.reduce((a,b)=>a+b,0) / totals.length;
  return {
    rounds: rounds.length,
    avg: Number(avg.toFixed(1)),
    best: Math.min(...totals),
    worst: Math.max(...totals),
    handicap: computeHandicap(pid)
  };
}

function renderAnalyticsPlayerList() {
  const ul = document.getElementById("analyticsPlayerList");
  if (!appData.players.length) {
    ul.innerHTML = "<li>No players yet.</li>";
    return;
  }
  ul.innerHTML = appData.players.map(p => `
    <li style="padding:6px 0;cursor:pointer;" onclick="showAnalytics('${p.id}')">
      ${p.name}
    </li>
  `).join("");
}

window.showAnalytics = function(pid) {
  const info = computeAnalytics(pid);
  const div = document.getElementById("analyticsResults");
  const canvas = document.getElementById("handicapChart");

  if (!info) {
    div.innerHTML = "<p>No rounds yet for this player.</p>";
    canvas.style.display = "none";
    return;
  }

  const hcText = info.handicap > 0
    ? `+${info.handicap.toFixed(1)}`
    : info.handicap.toFixed(1);

  div.innerHTML = `
    <p><strong>${getPlayer(pid).name}</strong></p>
    <p>Rounds: ${info.rounds}</p>
    <p>Average Score: ${info.avg.toFixed(1)}</p>
    <p>Best: ${info.best}</p>
    <p>Worst: ${info.worst}</p>
    <p>Handicap: ${hcText}</p>
  `;

  const timeline = getHandicapTimeline(pid);
  if (!timeline.length) {
    canvas.style.display = "none";
    return;
  }
  canvas.style.display = "block";

  const labels = timeline.map(t => t.date.toLocaleDateString());
  const data = timeline.map(t => t.handicap);

  if (handicapChartInstance) handicapChartInstance.destroy();

  handicapChartInstance = new Chart(canvas, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "Handicap",
        data,
        borderWidth: 3,
        tension: 0.3,
        pointRadius: 3
      }]
    },
    options: {
      plugins: { legend: { display: false }},
      scales: { y: { beginAtZero: false } }
    }
  });
};

/* =========================
   LEADERBOARDS
   ========================= */
function generateLeaderboards() {
  const rounds = appData.rounds;
  const results = [];

  rounds.forEach(r => {
    Object.keys(r.scores).forEach(pid => {
      const player = getPlayer(pid)?.name ?? "Player";
      const scores = r.scores[pid];
      const total = scores.reduce((a,b)=>a+b,0);
      const diffTotal = total - COURSE_PAR;
      const front = scores.slice(0,10).reduce((a,b)=>a+b,0);
      const diffFront = front - (10*PAR);
      const back = scores.slice(10).reduce((a,b)=>a+b,0);
      const diffBack = back - (10*PAR);

      results.push({
        player,
        date: new Date(r.date),
        total, diffTotal,
        front, diffFront,
        back, diffBack
      });
    });
  });

  return {
    overall: results.slice().sort((a,b)=>a.total-b.total).slice(0,10),
    barred:  results.slice().sort((a,b)=>a.front-b.front).slice(0,10),
    horned:  results.slice().sort((a,b)=>a.back-b.back).slice(0,10)
  };
}

function renderLeaderboards() {
  const data = generateLeaderboards();
  const overallDiv = document.getElementById("leaderboardOverall");
  const barredDiv  = document.getElementById("leaderboardBarred");
  const hornedDiv  = document.getElementById("leaderboardHorned");

  overallDiv.innerHTML =
    "<h3>üèÜ Best Combined (20 holes)</h3>" +
    (data.overall.length
      ? "<ol>" + data.overall.map(r =>
          `<li>${r.player}: ${r.total} (${fmtDiff(r.diffTotal)}) ‚Äî ${r.date.toLocaleDateString()}</li>`
        ).join("") + "</ol>"
      : "<p>No rounds yet.</p>");

  barredDiv.innerHTML =
    "<h3>ü¶Ö Barred Owl (Front 10)</h3>" +
    (data.barred.length
      ? "<ol>" + data.barred.map(r =>
          `<li>${r.player}: ${r.front} (${fmtDiff(r.diffFront)}) ‚Äî ${r.date.toLocaleDateString()}</li>`
        ).join("") + "</ol>"
      : "<p>No rounds yet.</p>");

  hornedDiv.innerHTML =
    "<h3>ü¶â Great Horned (Back 10)</h3>" +
    (data.horned.length
      ? "<ol>" + data.horned.map(r =>
          `<li>${r.player}: ${r.back} (${fmtDiff(r.diffBack)}) ‚Äî ${r.date.toLocaleDateString()}</li>`
        ).join("") + "</ol>"
      : "<p>No rounds yet.</p>");
}

/* =========================
   COURSE ANALYTICS
   ========================= */
function renderCourseAnalytics() {
  const container = document.getElementById("courseAnalyticsContainer");
  const canvas = document.getElementById("courseAnalyticsChart");
  container.innerHTML = "";

  if (!appData.rounds.length) {
    container.innerHTML = "<p>No rounds recorded yet.</p>";
    if (courseAnalyticsChart) courseAnalyticsChart.destroy();
    return;
  }

  const holeStats = Array(HOLES).fill(null).map((_, i) => ({
    hole: i + 1,
    name: HOLE_NAMES[i],
    scores: []
  }));

  appData.rounds.forEach(r => {
    Object.values(r.scores).forEach(arr => {
      arr.forEach((score, i) => {
        if (score !== null) holeStats[i].scores.push(score);
      });
    });
  });

  const difficultyData = holeStats.map(h => {
    if (!h.scores.length) return { ...h, avg: null, diff: null };
    const avg = h.scores.reduce((a,b)=>a+b,0) / h.scores.length;
    return { ...h, avg, diff: avg - PAR };
  });

  difficultyData.sort((a,b)=>(b.diff ?? -999) - (a.diff ?? -999));

  let html = "<table><tr><th>#</th><th>Hole</th><th>Avg</th><th>Œî</th></tr>";
  difficultyData.forEach((h, idx) => {
    html += `<tr>
      <td>${idx+1}</td>
      <td>${h.name}</td>
      <td>${h.avg !== null ? h.avg.toFixed(2) : "-"}</td>
      <td>${h.diff !== null ? fmtDiff(h.diff) : "-"}</td>
    </tr>`;
  });
  html += "</table>";
  container.innerHTML = html;

  const labels = difficultyData.map(h => `H${h.hole}`);
  const values = difficultyData.map(h => h.diff ?? 0);

  if (courseAnalyticsChart) courseAnalyticsChart.destroy();

  courseAnalyticsChart = new Chart(canvas, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: values.map(v =>
          v > 0.5 ? "#ff6b6b" : v > 0 ? "#ffd93b" : "#7dd87d"
        )
      }]
    },
    options: {
      plugins: { legend: { display: false }},
      scales: {
        y: { title: { display: true, text: "Avg vs Par (Strokes)" } }
      }
    }
  });
}

/* =========================
   EXPORT / IMPORT
   ========================= */
function exportCSV() {
  if (!appData.rounds.length) {
    alert("No rounds to export yet.");
    return;
  }
  const rows = ["Date,Player,Hole,Score"];
  appData.rounds.forEach(r => {
    Object.keys(r.scores).forEach(pid => {
      const player = getPlayer(pid)?.name ?? "Player";
      r.scores[pid].forEach((score, idx) => {
        rows.push(`${r.date},${player},${idx+1},${score}`);
      });
    });
  });
  const blob = new Blob([rows.join("\n")], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `backyard-putting-scores-${new Date().toISOString().split("T")[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function exportBackupJSON() {
  const json = JSON.stringify(appData, null, 2);
  const blob = new Blob([json], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `backyard-putting-backup-${new Date().toISOString().split("T")[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importBackupJSON(file) {
  const reader = new FileReader();
  reader.onload = async () => {
    try {
      const data = JSON.parse(reader.result);
      if (!data.players || !data.rounds) {
        alert("Invalid backup file.");
        return;
      }
      appData = data;
      saveLocal();
      await saveToFirebase();
      alert("Backup restored successfully!");
      renderPlayers();
      showScreen("screen-home");
    } catch (e) {
      console.error(e);
      alert("Error reading backup file.");
    }
  };
  reader.readAsText(file);
}

/* =========================
   INIT & BUTTON WIRING
   ========================= */
function initButtons() {
  document.getElementById("btnHomeStart").onclick = () => {
    renderPlayerSelection();
    showScreen("screen-select-players");
  };
  document.getElementById("btnHomePlayers").onclick = () => {
    renderPlayers();
    showScreen("screen-players");
  };
  document.getElementById("btnHomeHistory").onclick = () => {
    renderHistory();
    showScreen("screen-history");
  };
  document.getElementById("btnHomeAnalytics").onclick = () => {
    renderAnalyticsPlayerList();
    document.getElementById("analyticsResults").innerHTML = "";
    document.getElementById("handicapChart").style.display = "none";
    showScreen("screen-analytics");
  };
  document.getElementById("btnHomeLeaderboard").onclick = () => {
    renderLeaderboards();
    showScreen("screen-leaderboards");
  };
  document.getElementById("btnHomeCourseAnalytics").onclick = () => {
    renderCourseAnalytics();
    showScreen("screen-course-analytics");
  };
  document.getElementById("btnHomeExport").onclick = exportCSV;
  document.getElementById("btnExportJSON").onclick = exportBackupJSON;

  document.getElementById("btnImportBackup").onclick = () => {
    document.getElementById("backupFileInput").click();
  };
  document.getElementById("backupFileInput").onchange = e => {
    const file = e.target.files[0];
    if (file) importBackupJSON(file);
  };

  document.getElementById("btnAddPlayer").onclick = async () => {
    const input = document.getElementById("playerNameInput");
    const name = input.value.trim();
    if (!name) return;
    appData.players.push({ id: "p_" + Date.now(), name });
    input.value = "";
    saveLocal();
    await saveToFirebase();
    renderPlayers();
  };

  document.getElementById("btnBackFromPlayers").onclick = () => showScreen("screen-home");
  document.getElementById("btnBackFromSelect").onclick = () => showScreen("screen-home");
  document.getElementById("btnBackFromHistory").onclick = () => showScreen("screen-home");
  document.getElementById("btnBackFromAnalytics").onclick = () => showScreen("screen-home");
  document.getElementById("btnBackFromLeaderboards").onclick = () => showScreen("screen-home");
  document.getElementById("btnBackFromCourseAnalytics").onclick = () => showScreen("screen-home");

  document.getElementById("btnStartRoundFromSelection").onclick = () => {
    const ids = [...document.querySelectorAll("#playerSelectList input:checked")].map(cb => cb.value);
    if (!ids.length) {
      alert("Select at least one player.");
      return;
    }
    currentRound = {
      id: "r_" + Date.now(),
      date: new Date().toISOString(),
      playerIds: ids.slice(),
      currentHole: 1,
      scores: Object.fromEntries(ids.map(id => [id, Array(HOLES).fill(null)]))
    };
    editModeRoundId = null;
    renderRound();
    handleOrientation();
    showScreen("screen-round");
  };

  document.getElementById("btnPrevHole").onclick = () => {
    if (!currentRound) return;
    currentRound.currentHole = Math.max(1, currentRound.currentHole - 1);
    renderRound();
    renderScorecard();
  };
  document.getElementById("btnNextHole").onclick = () => {
    if (!currentRound) return;
    currentRound.currentHole = Math.min(HOLES, currentRound.currentHole + 1);
    renderRound();
    renderScorecard();
  };
  document.getElementById("btnFinishRoundBottom").onclick = finalizeRound;
  document.getElementById("btnBackFromRound").onclick = () => {
    if (confirm("Cancel this round? Unsaved changes will be lost.")) {
      currentRound = null;
      editModeRoundId = null;
      showScreen("screen-home");
    }
  };
  document.getElementById("btnSummaryDone").onclick = () => showScreen("screen-home");

  document.addEventListener("click", (e) => {
    if (!currentRound) return;
    if (!e.target.classList.contains("scorecell")) return;

    const pid = e.target.dataset.player;
    const holeIdx = parseInt(e.target.dataset.hole, 10);
    if (!pid || Number.isNaN(holeIdx)) return;

    const existing = currentRound.scores[pid][holeIdx];
    const input = prompt(
      `Score for ${getPlayer(pid)?.name || "Player"} on Hole ${holeIdx + 1}:`,
      existing ?? ""
    );
    if (input === null) return;

    const val = parseInt(input, 10);
    if (!Number.isInteger(val) || val < 1 || val > 10) return;

    currentRound.scores[pid][holeIdx] = val;

    renderScorecard();
    renderRound();
    updateSaveButtonState();
  });

  let touchStartX = 0;
  document.addEventListener("touchstart", e => {
    if (!e.changedTouches || !e.changedTouches.length) return;
    touchStartX = e.changedTouches[0].screenX;
  });
  document.addEventListener("touchend", e => {
    if (!currentRound || !e.changedTouches || !e.changedTouches.length) return;
    const dx = e.changedTouches[0].screenX - touchStartX;
    if (dx > 60) {
      currentRound.currentHole = Math.max(1, currentRound.currentHole - 1);
      renderRound();
      renderScorecard();
    } else if (dx < -60) {
      currentRound.currentHole = Math.min(HOLES, currentRound.currentHole + 1);
      renderRound();
      renderScorecard();
    }
  });

  window.addEventListener("orientationchange", handleOrientation);
  window.addEventListener("resize", handleOrientation);
}

/* =========================
   SERVICE WORKER (OPTIONAL)
   ========================= */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .catch(err => console.log("SW registration failed:", err));
}

/* =========================
   APP INIT
   ========================= */
loadLocal();
renderPlayers();
showScreen("screen-home");
initButtons();
initFirebase(); // connect to Firebase Spark if available
</script>
</body>
</html>
